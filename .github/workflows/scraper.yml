name: Purse Forum Scraper

# ìë™ ì‹¤í–‰ ìŠ¤ì¼€ì¤„ ì„¤ì •
on:
  # ìˆ˜ë™ ì‹¤í–‰ (Actions íƒ­ì—ì„œ ì§ì ‘ ì‹¤í–‰)
  workflow_dispatch:
    inputs:
      keyword:
        description: 'ê²€ìƒ‰ í‚¤ì›Œë“œ'
        required: true
        default: 'rhinoplasty'
      max_pages:
        description: 'ìµœëŒ€ í˜ì´ì§€ ìˆ˜'
        required: false
        default: '5'
      max_threads:
        description: 'ìµœëŒ€ ìŠ¤ë ˆë“œ ìˆ˜'
        required: false
        default: '50'
  
  # ìë™ ì‹¤í–‰ ìŠ¤ì¼€ì¤„ (ì„ íƒì‚¬í•­)
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œ (í•œêµ­ ì‹œê°„ ê¸°ì¤€ 18:00 UTC)
    - cron: '0 0 * * *'
  
  # Push ì´ë²¤íŠ¸ (ì½”ë“œ ì—…ë°ì´íŠ¸ ì‹œ)
  push:
    branches: [ main ]

jobs:
  scrape:
    runs-on: ubuntu-latest
    
    steps:
    # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v3
    
    # 2. Python ì„¤ì •
    - name: ğŸ Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    # 3. Chrome ì„¤ì¹˜
    - name: ğŸŒ Chrome ì„¤ì¹˜
      uses: browser-actions/setup-chrome@latest
      with:
        chrome-version: stable
    
    # 4. ChromeDriver ì„¤ì¹˜
    - name: ğŸš— ChromeDriver ì„¤ì¹˜
      uses: nanasess/setup-chromedriver@master
    
    # 5. ì˜ì¡´ì„± ì„¤ì¹˜
    - name: ğŸ“¦ íŒ¨í‚¤ì§€ ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    # 6. êµ¬ê¸€ ì¸ì¦ íŒŒì¼ ìƒì„±
    - name: ğŸ”‘ êµ¬ê¸€ ì¸ì¦ ì„¤ì •
      run: |
        echo '${{ secrets.GOOGLE_CREDENTIALS }}' > credentials.json
    
    # 7. config.py ì—…ë°ì´íŠ¸
    - name: âš™ï¸ ì„¤ì • íŒŒì¼ ì—…ë°ì´íŠ¸
      run: |
        sed -i 's/YOUR_SPREADSHEET_ID_HERE/${{ secrets.SPREADSHEET_ID }}/g' config.py
        
        # workflow_dispatchë¡œ ì‹¤í–‰ëœ ê²½ìš° ì…ë ¥ê°’ ì‚¬ìš©
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          sed -i 's/SEARCH_KEYWORD = ".*"/SEARCH_KEYWORD = "${{ github.event.inputs.keyword }}"/g' config.py
          sed -i 's/MAX_PAGES = .*/MAX_PAGES = ${{ github.event.inputs.max_pages }}/g' config.py
          sed -i 's/MAX_THREADS = .*/MAX_THREADS = ${{ github.event.inputs.max_threads }}/g' config.py
        fi
    
    # 8. í¬ë¡¤ëŸ¬ ì‹¤í–‰
    - name: ğŸš€ í¬ë¡¤ëŸ¬ ì‹¤í–‰
      run: |
        python scraper.py
    
    # 9. ë¡œê·¸ ì €ì¥ (ì˜¤ë¥˜ ë°œìƒ ì‹œ)
    - name: ğŸ“‹ ë¡œê·¸ ì—…ë¡œë“œ
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: scraper-logs
        path: |
          *.log
          screenshots/